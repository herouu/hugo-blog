---
title: java虚拟机3_对象在内存中的布局
date: 2018-03-07 19:02:10
tags: ["java虚拟机"]

categories: ["java虚拟机"]
---

简单介绍：
a.创建对象的过程
b.对象分配内存的方式
c.创建对象时线程安全问题
d.对象的结构
e.对象访问定位

<!--more-->

### 1. 创建对象的过程

对象的创建过程：

- a.new 类名
- b.根据 new 的参数在常量池中定义一个类的符号引用，没有找到这个符号的引用，进行类的加载，解析，初始化。
- c.虚拟机为独享分配内存
- d.将分配的内存初始化为零值（不包括对象头）
- e.调用对象的 init 方法
  分配内存空间->考虑线程安全问题->初始化对象->执行构造方法

### 2. 对象分配内存的方式

- 指针碰撞
- 空闲列表

&emsp;&emsp;更改内存表的方式，查询空闲的内存块，并更改内存块的状态。

&emsp;&emsp;使用方式，是由 java 堆内存是否规整来决定的，java 堆是否规整是由垃圾回收器策略决定。如果垃圾回收器有压缩规整的功能，可以使用指针碰撞，否则使用空闲列表的方式。

### 3.创建对象时线程安全问题

- 线程同步，加锁
- 本地线程分配缓冲区（TLAB）

&emsp;&emsp;有几个线程就分配几个区域，每个线程操作不同的区域就不会出现线程安全问题，相对于加锁的方式提高效率。

### 4.对象的结构

- header 对象头

&emsp;&emsp;a.自身对象运行时数据(hash 值，gc 分代年龄，锁状态标志，线程持有锁，偏向线程 ID,偏向时间戳)

&emsp;&emsp;b.类型指针&emsp;&emsp;对象指向类的元数据的指针，虚拟机通过指针来确定对象是那个类的实例。

- instanceData

&emsp;&emsp;存储对象的有效信息，跟虚拟机的不同策略有关

- padding

&emsp;&emsp;相当于存储占位符，不是必须存在

### 5.对象访问定位

- 使用句柄

&emsp;&emsp;栈内存引用堆内存的一块位置，定位到句柄池，然后定位到堆内存。好处：栈内存引用不变，只改变句柄池的引用。

- 直接指针

&emsp;&emsp;Hotspot 使用，好处：速度快，减少性能开销。
不论使用哪种方式，都存储两个数据，
{到对象实例的数据指针、到对象类型数据的指针}
